#!/bin/bash

# --- 1. ZAŠTITA ---
CURRENT_OPTS=$(findmnt -n -o OPTIONS /)
if [[ "$CURRENT_OPTS" == *"@snapshots"* ]]; then
    echo "Sustav je pokrenut iz snapshota. Preskačem."
    exit 0
fi

# --- 2. DETEKCIJA ---
R_UUID=$(findmnt -n -o UUID /)
sync

# --- 3. SNAPSHOT ---
S_ID=$(snapper -c root create -d "Rescue-$(date +%Y%m%d)" --print-number)
[ -z "$S_ID" ] && exit 1

S_PATH="/.snapshots/$S_ID/snapshot"
btrfs property set -ts "$S_PATH" ro false

# --- 4. UKI GENERIRANJE ---
mkdir -p "$S_PATH/boot"
# Uzimamo trenutne mount opcije roota za UKI kernel parametre
R_OPTS=$(findmnt -n -o OPTIONS / | sed 's/subvol=[^,]*//g' | sed 's/,,/,/g' | sed 's/,$//')
echo "root=UUID=$R_UUID rw rootflags=subvol=/@snapshots/$S_ID/snapshot $R_OPTS" > /tmp/rescue_cmd

mkinitcpio -k /boot/vmlinuz-linux -c /etc/mkinitcpio.conf --uki "$S_PATH/boot/rescue.efi" --cmdline /tmp/rescue_cmd
chmod 644 "$S_PATH/boot/rescue.efi"

# --- 5. UNIVERZALNO KRPANJE FSTAB-A (Bez duplanja) ---
if [ -f "$S_PATH/etc/fstab" ]; then
    # Osiguraj mount pointe
    mkdir -p "$S_PATH/home" "$S_PATH/var/log" "$S_PATH/var/cache/pacman/pkg" "$S_PATH/var/tmp" "$S_PATH/.snapshots"

    TMP_FSTAB=$(mktemp)
    
    while IFS= read -r line || [ -n "$line" ]; do
        # Kopiraj komentare i prazne linije
        if [[ "$line" =~ ^# ]] || [[ -z "$line" ]]; then
            echo "$line" >> "$TMP_FSTAB"
            continue
        fi

        # Provjera mount pointa (2. stupac u fstabu)
        MP=$(echo "$line" | awk '{print $2}')

        if [ "$MP" == "/" ]; then
            # Mijenjamo samo subvol za root, ostalo (UUID, opcije) ostaje isto
            echo "$line" | sed "s|\(subvol=\)[^, ]*|\1/@snapshots/$S_ID/snapshot|g" >> "$TMP_FSTAB"
        else
            # Sve ostale linije (/home, /mnt, /var...) ostaju identične
            echo "$line" >> "$TMP_FSTAB"
        fi
    done < "$S_PATH/etc/fstab"

    mv "$TMP_FSTAB" "$S_PATH/etc/fstab"
    chmod 644 "$S_PATH/etc/fstab"
fi

# --- 6. BACKUP I ROTACIJA ---
DATE=$(date +%Y_%m_%d_%H.%M.%S)
DEST="/.bootbackup/${DATE}_post"
mkdir -p "$DEST"
rsync -a --delete /boot/ "$DEST/"
echo "$S_ID" > "$DEST/snap_id.txt"
ls -1dt /.bootbackup/*_post/ | tail -n +6 | xargs rm -rf 2>/dev/null

sync
grub-mkconfig -o /boot/grub/grub.cfg
echo "--- RESCUE SPREMAN (ID: $S_ID) ---"
